<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RX-7 FD Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
  font-family: system-ui;
}
#title {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
}
#rpm {
  position: absolute;
  top: 35px;
  left: 10px;
  color: #7CFF00;
}
#ui {
  position: absolute;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
}
button {
  padding: 14px 18px;
  font-size: 15px;
  background: #111;
  color: #7CFF00;
  border: 1px solid #7CFF00;
  border-radius: 6px;
}
button:active {
  background: #7CFF00;
  color: black;
}
</style>
</head>

<body>

<div id="title">Mazda RX-7 FD</div>
<div id="rpm">RPM: 0</div>

<model-viewer
  src="scene.glb"
  camera-controls
  exposure="1.2"
  shadow-intensity="1"
  style="width:100vw;height:100vh;">
</model-viewer>

<div id="ui">
  <button id="start">START</button>
  <button id="accel">ACCEL</button>
  <button id="rev">REV</button>
  <button id="brake">BRAKE</button>
</div>

<script>
let ctx, gain;
let osc = [];
let rpm = 0;
let engineOn = false;
let loop;

function startEngine() {
  ctx = new (window.AudioContext || window.webkitAudioContext)();

  const types = ["sawtooth","square","triangle","sine"];
  types.forEach(t => {
    let o = ctx.createOscillator();
    o.type = t;
    o.start();
    osc.push(o);
  });

  gain = ctx.createGain();
  gain.gain.value = 0;

  osc.forEach(o => o.connect(gain));
  gain.connect(ctx.destination);

  engineOn = true;
}

function updateSound() {
  osc[0].frequency.value = 200 + rpm * 3.2;
  osc[1].frequency.value = 160 + rpm * 2.7;
  osc[2].frequency.value = 140 + rpm * 2.3;
  osc[3].frequency.value = 90  + rpm * 1.2;

  gain.gain.value = 0.15 + rpm / 4000;
  document.getElementById("rpm").textContent = "RPM: " + Math.floor(rpm);
}

function accel(up) {
  clearInterval(loop);
  loop = setInterval(() => {
    rpm += up ? 10 : -14;
    rpm = Math.max(0, Math.min(rpm, 900));
    updateSound();
  }, 30);
}

document.getElementById("start").onclick = () => {
  if (!engineOn) startEngine();
};

document.getElementById("accel").ontouchstart =
document.getElementById("accel").onmousedown = () => accel(true);

document.getElementById("accel").ontouchend =
document.getElementById("accel").onmouseup = () => accel(false);

document.getElementById("rev").onclick = () => {
  if (!engineOn) return;
  rpm = 850;
  updateSound();
};

document.getElementById("brake").onclick = () => {
  rpm = 0;
  updateSound();
};
</script>

</body>
</html>
