<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Rotary Engine Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
  font-family: system-ui;
}
#title {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
}
#ui {
  position: absolute;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 12px;
}
button {
  padding: 14px 22px;
  font-size: 16px;
  background: #111;
  color: #7CFF00;
  border: 1px solid #7CFF00;
  border-radius: 6px;
}
button:active {
  background: #7CFF00;
  color: black;
}
#tacho {
  position: absolute;
  right: 10px;
  bottom: 110px;
}
</style>
</head>

<body>

<div id="title">Mazda RX-7 FD / 787B Rotary</div>
<canvas id="tacho" width="260" height="260"></canvas>

<model-viewer
  src="scene.glb"
  camera-controls
  exposure="1.1"
  shadow-intensity="1"
  style="width:100vw;height:100vh;">
</model-viewer>

<div id="ui">
  <button id="start">START</button>
  <button id="accel">ACCEL</button>
</div>

<script>
/* ===== ENGINE ===== */
let audioCtx, gain;
let osc = [];
let screamOsc;
let rpm = 0;
let targetRPM = 0;
let engineOn = false;
let limiter = false;

const idleRPM = 900;
const maxRPM = 10000;

function startEngine(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // 低音主体ロータリー
  ["sine","triangle","triangle"].forEach(type=>{
    const o = audioCtx.createOscillator();
    o.type = type;
    o.start();
    osc.push(o);
  });

  // 高回転787B悲鳴
  screamOsc = audioCtx.createOscillator();
  screamOsc.type = "sine";
  screamOsc.start();

  gain = audioCtx.createGain();
  gain.gain.value = 0;

  osc.forEach(o=>o.connect(gain));
  screamOsc.connect(gain);
  gain.connect(audioCtx.destination);

  rpm = idleRPM;
  targetRPM = idleRPM;
  engineOn = true;
}

function updateSound(){
  // 低回転の揺らぎ
  let low = Math.max(0, 1 - rpm / 2500);
  let fluct = (Math.random() - 0.5) * low * 80;
  let r = rpm + fluct;

  // 基音（かなり低め）
  osc[0].frequency.value = 25 + r * 0.55;
  osc[1].frequency.value = 18 + r * 0.42;
  osc[2].frequency.value = 12 + r * 0.30;

  // 787B悲鳴
  let screamLevel = Math.max(0, (rpm - 8000) / 2000);
  screamOsc.frequency.value = 1200 + screamLevel * 1800;

  gain.gain.value =
    0.25 +
    r / 22000 +
    screamLevel * 0.12;
}

// 回転・レブ制御
setInterval(()=>{
  if(targetRPM >= maxRPM && rpm >= maxRPM - 200){
    limiter = !limiter;
    rpm += limiter ? -500 : 200;
  } else {
    limiter = false;
  }

  let speed = targetRPM > rpm ? 0.22 : 0.13;
  rpm += (targetRPM - rpm) * speed;
  updateSound();
}, 25);

/* ===== UI ===== */
document.getElementById("start").onclick = ()=>{
  if(!engineOn) startEngine();
};

document.getElementById("accel").ontouchstart =
document.getElementById("accel").onmousedown = ()=>{
  targetRPM = maxRPM;
};

document.getElementById("accel").ontouchend =
document.getElementById("accel").onmouseup = ()=>{
  targetRPM = idleRPM;
};

/* ===== TACHOMETER ===== */
const canvas = document.getElementById("tacho");
const ctx = canvas.getContext("2d");

function drawTacho(){
  ctx.clearRect(0,0,260,260);
  ctx.translate(130,130);

  // レッドゾーン
  ctx.beginPath();
  ctx.arc(0,0,100,Math.PI + (8/10)*Math.PI,Math.PI*2);
  ctx.strokeStyle="red";
  ctx.lineWidth=8;
  ctx.stroke();

  // 外周
  ctx.beginPath();
  ctx.arc(0,0,100,Math.PI,0);
  ctx.strokeStyle="#aaa";
  ctx.lineWidth=3;
  ctx.stroke();

  // 数字
  for(let i=0;i<=10;i++){
    let a = Math.PI + (i/10)*Math.PI;
    let x = Math.cos(a)*80;
    let y = Math.sin(a)*80;
    ctx.fillStyle = i>=8 ? "red" : "white";
    ctx.font="bold 15px sans-serif";
    ctx.fillText(i, x-6, y+6);
  }

  ctx.fillStyle="#ccc";
  ctx.font="12px sans-serif";
  ctx.fillText("x1000 rpm", -38, 50);

  // 針
  let angle = Math.PI + (rpm/maxRPM)*Math.PI;
  ctx.rotate(angle);
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(90,0);
  ctx.strokeStyle="red";
  ctx.lineWidth=3;
  ctx.stroke();
  ctx.rotate(-angle);

  ctx.beginPath();
  ctx.arc(0,0,4,0,Math.PI*2);
  ctx.fillStyle="red";
  ctx.fill();

  ctx.resetTransform();
  requestAnimationFrame(drawTacho);
}
drawTacho();
</script>

</body>
</html>
