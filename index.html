<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RX-7 FD 787B Sound</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module"
  src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<style>
body {
  margin: 0;
  background: black;
  overflow: hidden;
  font-family: system-ui;
}
#title {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
}
#ui {
  position: absolute;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
}
button {
  padding: 14px 18px;
  font-size: 15px;
  background: #111;
  color: #7CFF00;
  border: 1px solid #7CFF00;
  border-radius: 6px;
}
button:active {
  background: #7CFF00;
  color: black;
}
#tacho {
  position: absolute;
  right: 10px;
  bottom: 110px;
}
</style>
</head>

<body>

<div id="title">Mazda RX-7 FD</div>

<canvas id="tacho" width="180" height="180"></canvas>

<model-viewer
  src="scene.glb"
  camera-controls
  exposure="1.2"
  shadow-intensity="1"
  style="width:100vw;height:100vh;">
</model-viewer>

<div id="ui">
  <button id="start">START</button>
  <button id="accel">ACCEL</button>
  <button id="rev">REV</button>
  <button id="brake">BRAKE</button>
</div>

<script>
/* ====== ENGINE SOUND ====== */
let ctx, gain, osc=[];
let rpm = 0;
let engineOn = false;
const maxRPM = 9000;
let loop;

function startEngine() {
  ctx = new (window.AudioContext || window.webkitAudioContext)();

  ["sawtooth","square","triangle","sine"].forEach(t=>{
    let o = ctx.createOscillator();
    o.type = t;
    o.start();
    osc.push(o);
  });

  gain = ctx.createGain();
  gain.gain.value = 0;

  osc.forEach(o=>o.connect(gain));
  gain.connect(ctx.destination);

  engineOn = true;
}

function updateSound() {
  // 低回転ほど揺れる（787B感）
  let jitterAmount = Math.max(0, 1 - rpm / 3000);
  let jitter = (Math.random() - 0.5) * jitterAmount * 80;

  let base = rpm + jitter;

  osc[0].frequency.value = 120 + base * 2.8;
  osc[1].frequency.value = 90  + base * 2.2;
  osc[2].frequency.value = 70  + base * 1.9;
  osc[3].frequency.value = 50  + base * 1.2;

  gain.gain.value = 0.12 + rpm / 12000;
}

function accel(up) {
  clearInterval(loop);
  loop = setInterval(()=>{
    rpm += up ? 15 : -20;
    rpm = Math.max(800, Math.min(rpm, maxRPM));
    updateSound();
  }, 30);
}

/* ====== TACHOMETER ====== */
const canvas = document.getElementById("tacho");
const ctx2d = canvas.getContext("2d");

function drawTacho() {
  ctx2d.clearRect(0,0,180,180);
  ctx2d.translate(90,90);

  // メーター外周
  ctx2d.beginPath();
  ctx2d.arc(0,0,80,Math.PI,0);
  ctx2d.strokeStyle="#7CFF00";
  ctx2d.lineWidth=3;
  ctx2d.stroke();

  // 針
  let angle = Math.PI + (rpm / maxRPM) * Math.PI;
  ctx2d.rotate(angle);
  ctx2d.beginPath();
  ctx2d.moveTo(0,0);
  ctx2d.lineTo(70,0);
  ctx2d.strokeStyle="red";
  ctx2d.lineWidth=3;
  ctx2d.stroke();
  ctx2d.rotate(-angle);

  ctx2d.resetTransform();
  requestAnimationFrame(drawTacho);
}
drawTacho();

/* ====== UI ====== */
document.getElementById("start").onclick=()=>{
  if(!engineOn){
    startEngine();
    rpm=900; // アイドリング
  }
};
document.getElementById("accel").ontouchstart =
document.getElementById("accel").onmousedown = ()=>accel(true);

document.getElementById("accel").ontouchend =
document.getElementById("accel").onmouseup = ()=>accel(false);

document.getElementById("rev").onclick=()=>{
  rpm=8500;
  updateSound();
};
document.getElementById("brake").onclick=()=>{
  rpm=900;
  updateSound();
};
</script>

</body>
</html>
